
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Processor Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body, html { height: 100%; }
        .main-container { display: flex; height: 100%; }
        .left-panel { width: 50%; padding: 1rem; border-right: 1px solid #dee2e6; overflow-y: auto; }
        .right-panel { width: 50%; display: flex; flex-direction: column; height: 100%; }
        #chat-history { flex-grow: 1; padding: 1rem; overflow-y: auto; }
        .chat-form { padding: 1rem; border-top: 1px solid #dee2e6; }
        .message { margin-bottom: 1rem; }
        .message.user { text-align: right; }
        .message .content { display: inline-block; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .message.user .content { background-color: #0d6efd; color: white; }
        .message.agent .content { background-color: #e9ecef; }
        .message img { max-width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
        .table-responsive { max-height: 400px; }
        .thought-process { border-left: 3px solid #0d6efd; padding-left: 10px; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Panel for File Preview -->
        <div class="left-panel">
            <h4>Excel File Control</h4>
            <div class="mb-3">
                <label for="fileUpload" class="form-label">Select Excel File</label>
                <input class="form-control" type="file" id="fileUpload" accept=".xlsx, .xls">
            </div>
            <hr>
            <h4>File Preview</h4>
            <div id="excel-preview">Select a file to see a preview.</div>
        </div>

        <!-- Right Panel for Chat -->
        <div class="right-panel">
            <div id="chat-history">
                <div class="message agent">
                    <div class="content">Hello! Please upload an Excel file to get started.</div>
                </div>
            </div>
            <div class="chat-form">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" id="promptInput" class="form-control" placeholder="Type your command..." autocomplete="off" disabled>
                        <button class="btn btn-primary" type="submit" disabled>Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let currentFilePath = null;

        // --- DOM Elements ---
        const fileUpload = document.getElementById('fileUpload');
        const excelPreview = document.getElementById('excel-preview');
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chatForm');
        const promptInput = document.getElementById('promptInput');
        const sendButton = chatForm.querySelector('button');

        // --- Event Listeners ---
        fileUpload.addEventListener('change', handleFileUpload);
        chatForm.addEventListener('submit', handleChatSubmit);

        // --- Functions ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            addMessage('Uploading file...', 'agent');
            excelPreview.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
            const formData = new FormData();
            formData.append('file', file);

            try {
                const uploadResponse = await fetch('/api/upload', { method: 'POST', body: formData });
                const uploadData = await uploadResponse.json();
                if (uploadData.error) throw new Error(uploadData.error);
                currentFilePath = uploadData.file_path;

                const previewResponse = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_path: currentFilePath })
                });
                const previewData = await previewResponse.json();
                if (previewData.error) throw new Error(previewData.error);

                excelPreview.innerHTML = createHtmlTable(previewData.data);
                addMessage(`File '${file.name}' uploaded successfully. You can now ask me questions about it.`, 'agent');
                promptInput.disabled = false;
                sendButton.disabled = false;

            } catch (error) {
                addMessage(`Error: ${error.message}`, 'agent');
                excelPreview.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        }

        async function handleChatSubmit(event) {
            event.preventDefault();
            const prompt = promptInput.value.trim();
            if (!prompt || !currentFilePath) return;

            addMessage(prompt, 'user');
            promptInput.value = '';
            promptInput.disabled = true;
            sendButton.disabled = true;
            addMessage('Thinking...', 'agent', '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>');

            try {
                const response = await fetch('/api/agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, file_path: currentFilePath })
                });
                const data = await response.json();
                chatHistory.removeChild(chatHistory.lastChild);
                handleAgentResponse(data);
            } catch (error) {
                chatHistory.removeChild(chatHistory.lastChild);
                addMessage(`Network Error: ${error.message}`, 'agent');
            }

            promptInput.disabled = false;
            sendButton.disabled = false;
            promptInput.focus();
        }

        function handleAgentResponse(response) {
            if (response.error) {
                addMessage(`Server Error: ${response.error}`, 'agent');
                return;
            }

            const answer = response.answer || "I didn't get a clear answer from the agent.";
            const artifacts = response.artifacts || [];
            const steps = response.steps || [];

            let htmlContent = '';

            if (steps.length > 0) {
                htmlContent += `<details><summary class="text-muted">Show thought process</summary><div class="thought-process">`;
                steps.forEach((step, index) => {
                    let stepHtml = `<h6>Step ${index + 1}</h6>`;
                    if(step.thought) {
                        stepHtml += `<p class="mb-1"><strong>Thought:</strong> ${step.thought}</p>`;
                    }
                    if(step.tool_call) {
                        stepHtml += `<strong>Tool Call:</strong><pre class="mb-1"><code>${JSON.stringify(step.tool_call, null, 2)}</code></pre>`;
                    }
                    if(step.observation) {
                        let obsContent = '';
                        try { obsContent = JSON.stringify(JSON.parse(step.observation), null, 2); } catch (e) { obsContent = step.observation; }
                        stepHtml += `<strong>Observation:</strong><pre class="mb-1"><code>${obsContent}</code></pre>`;
                    }
                    htmlContent += `<div class="p-2 border-start border-2 mb-2">${stepHtml}</div>`;
                });
                htmlContent += `</div></details>`;
            }

            if (artifacts.length > 0) {
                artifacts.forEach(artifact => {
                    if (artifact.type === 'chart') {
                        htmlContent += `<div><img src="${artifact.url}?t=${new Date().getTime()}" alt="Generated Chart" class="mt-2 img-fluid"></div>`;
                    } else if (artifact.type === 'file') {
                        htmlContent += `<div><a href="${artifact.url}" class="btn btn-success btn-sm mt-2" download="${artifact.filename}">Download ${artifact.filename}</a></div>`;
                    }
                });
            }
            
            addMessage(answer, 'agent', htmlContent);
        }

        function addMessage(text, sender, htmlContent = '') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.innerText = text;

            if (htmlContent) {
                contentDiv.innerHTML += htmlContent;
            }

            messageDiv.appendChild(contentDiv);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function createHtmlTable(data) {
            if (!data || data.length === 0) return '<p>No data to display.</p>';
            const headers = Object.keys(data[0]);
            let table = '<div class="table-responsive"><table class="table table-striped table-bordered table-sm"><thead><tr>';
            headers.forEach(h => table += `<th>${h}</th>`);
            table += '</tr></thead><tbody>';
            data.forEach(row => {
                table += '<tr>';
                headers.forEach(h => table += `<td>${row[h] === null ? '' : row[h]}</td>`);
                table += '</tr>';
            });
            table += '</tbody></table></div>';
            return table;
        }

    </script>
</body>
</html>
